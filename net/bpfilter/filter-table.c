// SPDX-License-Identifier: GPL-2.0
/*
 * Copyright (c) 2021 Telegram FZ-LLC
 */

#define _GNU_SOURCE

#include "filter-table.h"

#include <linux/err.h>
#include <linux/kernel.h>

#include <sys/types.h>
#include <unistd.h>

#include <errno.h>
#include <stdlib.h>

#include "codegen.h"
#include "context.h"
#include "msgfmt.h"
#include "rule.h"
#include "sockopt.h"

struct filter_table_context {
	struct shared_codegen shared;
	struct codegen local_in;
	struct codegen local_out;
};

static struct table *filter_table_create(struct context *ctx,
					 const struct bpfilter_ipt_replace *ipt_replace)
{
	struct table *t = create_table(ctx, ipt_replace);

	if (!IS_ERR_OR_NULL(t))
		t->table_ops = &filter_table_ops;

	return t;
}

static bool filter_table_has_standard_forward_chain(const struct table *table)
{
	const struct bpfilter_ipt_standard_target *target;
	const struct rule *rule_front, *rule_last;

	rule_front = &table->rules[table->hook_entry[BPFILTER_INET_HOOK_FORWARD]];
	rule_last = &table->rules[table->underflow[BPFILTER_INET_HOOK_FORWARD]];

	if (rule_last - rule_front != 0)
		return false;

	if (!is_rule_unconditional(rule_last))
		return false;

	if (!rule_has_standard_target(rule_last))
		return false;

	if (standard_target_verdict(rule_last->target.ipt_target) >= 0)
		return false;

	target = (const struct bpfilter_ipt_standard_target *)rule_last->target.ipt_target;

	return convert_verdict(target->verdict) == BPFILTER_NF_ACCEPT;
}

static int filter_table_codegen(struct context *ctx, struct table *table)
{
	struct filter_table_context *table_ctx;
	int err;

	BUG_ON(table->table_ops != &filter_table_ops);

	if (table->ctx)
		return -EINVAL;

	if (!filter_table_has_standard_forward_chain(table))
		return -EOPNOTSUPP;

	table_ctx = calloc(1, sizeof(*table_ctx));
	if (!table_ctx)
		return -ENOMEM;

	create_shared_codegen(&table_ctx->shared);

	err = create_codegen(&table_ctx->local_in, BPF_PROG_TYPE_XDP);
	if (err)
		return err;
	table_ctx->local_in.ctx = ctx;
	table_ctx->local_in.shared_codegen = &table_ctx->shared;

	err = try_codegen(&table_ctx->local_in, table, BPFILTER_INET_HOOK_LOCAL_IN);
	if (err)
		goto err_free_local_in;

	err = create_codegen(&table_ctx->local_out, BPF_PROG_TYPE_SCHED_CLS);
	if (err)
		goto err_free_local_in;
	table_ctx->local_out.ctx = ctx;
	table_ctx->local_out.shared_codegen = &table_ctx->shared;

	err = try_codegen(&table_ctx->local_out, table, BPFILTER_INET_HOOK_LOCAL_OUT);
	if (err)
		goto err_free_local_out;

	table->ctx = table_ctx;

	return 0;

err_free_local_out:
	free_codegen(&table_ctx->local_out);

err_free_local_in:
	free_codegen(&table_ctx->local_in);

	free(table_ctx);

	return err;
}

static int filter_table_install(struct context *ctx, struct table *table)
{
	struct filter_table_context *table_ctx;
	int err;

	if (!table->ctx)
		return -EINVAL;

	table_ctx = (struct filter_table_context *)table->ctx;

	err = table_ctx->local_in.codegen_ops->load_img(&table_ctx->local_in);
	if (err < 0) {
		BFLOG_DEBUG(ctx, "Cannot load chain INPUT in table filter: %s\n",
			    table_ctx->local_in.log_buf);
		return err;
	}

	err = table_ctx->local_out.codegen_ops->load_img(&table_ctx->local_out);
	if (err < 0) {
		BFLOG_DEBUG(ctx, "Cannot load chain OUTPUT in table filter: %s\n",
			    table_ctx->local_out.log_buf);
		table_ctx->local_in.codegen_ops->unload_img(&table_ctx->local_in);
		return err;
	}

	return 0;
}

static void filter_table_uninstall(struct context *ctx, struct table *table)
{
	struct filter_table_context *table_ctx;

	BUG_ON(!table->ctx);

	table_ctx = (struct filter_table_context *)table->ctx;

	table_ctx->local_in.codegen_ops->unload_img(&table_ctx->local_in);
	table_ctx->local_out.codegen_ops->unload_img(&table_ctx->local_out);
}

static void filter_table_free(struct table *table)
{
	if (table->ctx) {
		struct filter_table_context *table_ctx;

		table_ctx = (struct filter_table_context *)table->ctx;

		free_codegen(&table_ctx->local_in);
		free_codegen(&table_ctx->local_out);
		free(table_ctx);
	}

	free_table(table);
}

const struct table_ops filter_table_ops = { .name = "filter",
					    .create = filter_table_create,
					    .codegen = filter_table_codegen,
					    .install = filter_table_install,
					    .uninstall = filter_table_uninstall,
					    .free = filter_table_free };

static uint8_t filter_table_replace_blob[] = {
	0x66, 0x69, 0x6c, 0x74, 0x65, 0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x78, 0x02, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x98, 0x00, 0x00, 0x00, 0x30, 0x01, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x98, 0x00, 0x00,
	0x00, 0x30, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x10, 0x32,
	0x40, 0x36, 0x43, 0x56, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xfe, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x98, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0xb0, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x45, 0x52, 0x52, 0x4f, 0x52, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x45, 0x52, 0x52, 0x4f, 0x52, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

int create_filter_table(struct context *ctx)
{
	struct mbox_request req;

	req.addr = (__u64)filter_table_replace_blob;
	req.len = ARRAY_SIZE(filter_table_replace_blob);
	req.is_set = 1;
	req.cmd = BPFILTER_IPT_SO_SET_REPLACE;
	req.pid = getpid();

	return handle_sockopt_request(ctx, &req);
}
