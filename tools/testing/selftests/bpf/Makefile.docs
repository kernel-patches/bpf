# SPDX-License-Identifier: GPL-2.0-only

include ../../../scripts/Makefile.include
include ../../../scripts/utilities.mak

INSTALL ?= install
RM ?= rm -f
RMDIR ?= rmdir --ignore-fail-on-non-empty

ifeq ($(V),1)
  Q =
else
  Q = @
endif

prefix ?= /usr/local
mandir ?= $(prefix)/man
man7dir = $(mandir)/man7

HELPERS_RST = bpf-helpers.rst
MAN7_RST = $(HELPERS_RST)

_DOC_MAN7 = $(patsubst %.rst,%.7,$(MAN7_RST))
DOC_MAN7 = $(addprefix $(OUTPUT),$(_DOC_MAN7))

DOCTARGETS := helpers

docs: $(DOCTARGETS)
helpers: man7
man7: $(DOC_MAN7)

RST2MAN_DEP := $(shell command -v rst2man 2>/dev/null)

# Configure make rules for the man page bpf-$1.$2.
# $1 - target for scripts/bpf_doc.py
# $2 - man page section to generate the troff file
define DOCS_RULES =
$(OUTPUT)bpf-$1.rst: ../../../../include/uapi/linux/bpf.h
	$$(QUIET_GEN)../../../../scripts/bpf_doc.py $1 \
		--filename $$< > $$@

$(OUTPUT)%.7: $(OUTPUT)%.rst
ifndef RST2MAN_DEP
	$(error "rst2man not found, but required to generate man pages")
endif
	$(QUIET_GEN)rst2man $< > $@

docs-clean:
	$(call QUIET_CLEAN, eBPF_helpers-manpage)
	$(Q)$(RM) $(DOC_MAN7) $(OUTPUT)$(HELPERS_RST)

docs-install: helpers
	$(call QUIET_INSTALL, eBPF_helpers-manpage)
	$(Q)$(INSTALL) -d -m 755 $(DESTDIR)$(man7dir)
	$(Q)$(INSTALL) -m 644 $(DOC_MAN7) $(DESTDIR)$(man7dir)

docs-uninstall:
	$(call QUIET_UNINST, eBPF_helpers-manpage)
	$(Q)$(RM) $(addprefix $(DESTDIR)$(man7dir)/,$(_DOC_MAN7))
	$(Q)$(RMDIR) $(DESTDIR)$(man7dir)

.PHONY: docs docs-clean docs-install docs-uninstall
