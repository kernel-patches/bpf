// SPDX-License-Identifier: GPL-2.0

#define _GNU_SOURCE

#include <linux/bpf.h>
#include <linux/bpfilter.h>

#include <linux/err.h>
#include <linux/pkt_cls.h>

#include "../../kselftest_harness.h"

#include <stdint.h>

#include "codegen.h"
#include "context.h"
#include "filter-table.h"
#include "logger.h"
#include "table.h"

#include "bpfilter_util.h"

FIXTURE(test_codegen)
{
	struct context ctx;
	struct shared_codegen shared_codegen;
	struct codegen codegen;
	struct table *table;
	int prog_fd;
	uint32_t retval;
	union bpf_attr attr;
};

FIXTURE_VARIANT(test_codegen)
{
	const struct bpfilter_ipt_replace *replace_blob;
	size_t replace_blob_size;
	const uint8_t *packet;
	size_t packet_size;
	enum bpf_prog_type prog_type;
	int hook;
	int expected_retval;
};

/*
 *  Generated by iptables-save v1.8.2 on Sat May  8 05:22:41 2021
 * *filter
 * :INPUT ACCEPT [0:0]
 * :FORWARD ACCEPT [0:0]
 * :OUTPUT ACCEPT [0:0]
 * -A INPUT -s 1.1.1.1/32 -d 2.2.2.2/32 -j DROP
 * -A INPUT -s 2.2.0.0/16 -d 3.0.0.0/8 -j DROP
 * -A INPUT -p udp -m udp --sport 100 --dport 500 -j DROP
 * COMMIT
 */

static const uint8_t user_defined_chain_blob[] = {
	0x66, 0x69, 0x6c, 0x74, 0x65, 0x72, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x0e, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
	0x70, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x90, 0x02, 0x00, 0x00,
	0x28, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0xf8, 0x01, 0x00, 0x00,
	0x90, 0x02, 0x00, 0x00, 0x28, 0x03, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00,
	0xe0, 0x26, 0x99, 0xca, 0x67, 0x55, 0x00, 0x00,
	0x01, 0x01, 0x01, 0x01, 0x02, 0x02, 0x02, 0x02,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x70, 0x00, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
	0x02, 0x02, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
	0xff, 0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x70, 0x00, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xa0, 0x00, 0xc8, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x30, 0x00, 0x75, 0x64, 0x70, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x64, 0x00, 0x64, 0x00, 0xf4, 0x01, 0xf4, 0x01,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x70, 0x00, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xfe, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x70, 0x00, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xfe, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x70, 0x00, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xfe, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x70, 0x00, 0xb0, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x40, 0x00, 0x45, 0x52, 0x52, 0x4f, 0x52, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x45, 0x52, 0x52, 0x4f, 0x52, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Generated by scapy
// Ether(src='00:11:22:33:44:55',dst='66:77:88:99:aa:bb')/IP(src='1.1.1.1',dst='2.2.2.2')/UDP(sport=100,dport=200)
static const uint8_t udp_packet_1[] = {
	0x66, 0x77, 0x88, 0x99, 0xaa, 0xbb, 0x00, 0x11,
	0x22, 0x33, 0x44, 0x55, 0x08, 0x00, 0x45, 0x00,
	0x00, 0x1c, 0x00, 0x01, 0x00, 0x00, 0x40, 0x11,
	0x74, 0xcb, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02,
	0x02, 0x02, 0x00, 0x64, 0x00, 0xc8, 0x00, 0x08,
	0xf8, 0xac,
};

// Ether(src='00:11:22:33:44:55',dst='66:77:88:99:aa:bb')/IP(src='2.2.2.2',dst='3.1.4.1')/UDP(sport=100,dport=200)
static const uint8_t udp_packet_2[] = {
	0x66, 0x77, 0x88, 0x99, 0xaa, 0xbb, 0x00, 0x11,
	0x22, 0x33, 0x44, 0x55, 0x08, 0x00, 0x45, 0x00,
	0x00, 0x1c, 0x00, 0x01, 0x00, 0x00, 0x40, 0x11,
	0x6f, 0xcb, 0x02, 0x02, 0x02, 0x02, 0x03, 0x01,
	0x04, 0x01, 0x00, 0x64, 0x00, 0xc8, 0x00, 0x08,
	0xf3, 0xac,
};

// Ether(src='00:11:22:33:44:55',dst='66:77:88:99:aa:bb')/IP(src='2.7.1.8',dst='3.1.4.1')/UDP(sport=100,dport=500)
static const uint8_t udp_packet_3[] = {
	0x66, 0x77, 0x88, 0x99, 0xaa, 0xbb, 0x00, 0x11,
	0x22, 0x33, 0x44, 0x55, 0x08, 0x00, 0x45, 0x00,
	0x00, 0x1c, 0x00, 0x01, 0x00, 0x00, 0x40, 0x11,
	0x70, 0xc0, 0x02, 0x07, 0x01, 0x08, 0x03, 0x01,
	0x04, 0x01, 0x00, 0x64, 0x01, 0xf4, 0x00, 0x08,
	0xf3, 0x75,
};

// Ether(src='00:11:22:33:44:55',dst='66:77:88:99:aa:bb')/IP(src='5.5.5.5',dst='5.5.5.5')/UDP(sport=300,dport=300)
static const uint8_t udp_packet_4[] = {
	0x66, 0x77, 0x88, 0x99, 0xaa, 0xbb, 0x00, 0x11,
	0x22, 0x33, 0x44, 0x55, 0x08, 0x00, 0x45, 0x00,
	0x00, 0x1c, 0x00, 0x01, 0x00, 0x00, 0x40, 0x11,
	0x66, 0xbd, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
	0x05, 0x05, 0x01, 0x2c, 0x01, 0x2c, 0x00, 0x08,
	0xe9, 0x72,
};

FIXTURE_VARIANT_ADD(test_codegen, drop_by_ip_tc) {
	.replace_blob = (const struct bpfilter_ipt_replace *)user_defined_chain_blob,
	.replace_blob_size = ARRAY_SIZE(user_defined_chain_blob),
	.packet = udp_packet_1,
	.packet_size = ARRAY_SIZE(udp_packet_1),
	.prog_type = BPF_PROG_TYPE_SCHED_CLS,
	.hook = BPFILTER_INET_HOOK_LOCAL_IN,
	.expected_retval = TC_ACT_SHOT,
};

FIXTURE_VARIANT_ADD(test_codegen, drop_by_net_tc) {
	.replace_blob = (const struct bpfilter_ipt_replace *)user_defined_chain_blob,
	.replace_blob_size = ARRAY_SIZE(user_defined_chain_blob),
	.packet = udp_packet_2,
	.packet_size = ARRAY_SIZE(udp_packet_2),
	.prog_type = BPF_PROG_TYPE_SCHED_CLS,
	.hook = BPFILTER_INET_HOOK_LOCAL_IN,
	.expected_retval = TC_ACT_SHOT,
};

FIXTURE_VARIANT_ADD(test_codegen, drop_by_udp_port_tc) {
	.replace_blob = (const struct bpfilter_ipt_replace *)user_defined_chain_blob,
	.replace_blob_size = ARRAY_SIZE(user_defined_chain_blob),
	.packet = udp_packet_3,
	.packet_size = ARRAY_SIZE(udp_packet_3),
	.prog_type = BPF_PROG_TYPE_SCHED_CLS,
	.hook = BPFILTER_INET_HOOK_LOCAL_IN,
	.expected_retval = TC_ACT_SHOT,
};

FIXTURE_VARIANT_ADD(test_codegen, accept_tc) {
	.replace_blob = (const struct bpfilter_ipt_replace *)user_defined_chain_blob,
	.replace_blob_size = ARRAY_SIZE(user_defined_chain_blob),
	.packet = udp_packet_4,
	.packet_size = ARRAY_SIZE(udp_packet_4),
	.prog_type = BPF_PROG_TYPE_SCHED_CLS,
	.hook = BPFILTER_INET_HOOK_LOCAL_IN,
	.expected_retval = TC_ACT_UNSPEC,
};

FIXTURE_SETUP(test_codegen)
{
	logger_set_file(stderr);
	ASSERT_EQ(create_context(&self->ctx), 0);

	create_shared_codegen(&self->shared_codegen);
	ASSERT_EQ(0, create_codegen(&self->codegen, variant->prog_type));

	self->codegen.ctx = &self->ctx;
	self->codegen.shared_codegen = &self->shared_codegen;
	self->codegen.iptables_hook = variant->hook;

	self->table = filter_table_ops.create(&self->ctx, variant->replace_blob);
	ASSERT_FALSE(IS_ERR_OR_NULL(self->table));

	ASSERT_EQ(0, try_codegen(&self->codegen, self->table));

	self->prog_fd = load_img(&self->codegen);
	ASSERT_GT(self->prog_fd, -1)
	TH_LOG("load_img(): '%s': %s", STRERR(self->prog_fd),
	       self->codegen.log_buf);
};

FIXTURE_TEARDOWN(test_codegen)
{
	filter_table_ops.free(self->table);
	unload_img(&self->codegen);
	free_codegen(&self->codegen);
	free_context(&self->ctx);
	if (self->prog_fd > -1)
		close(self->prog_fd);
};

TEST_F(test_codegen, test_run)
{
	EXPECT_EQ(0, bpf_prog_test_run(self->prog_fd, variant->packet,
				       variant->packet_size, &self->retval))
	TH_LOG("cannot bpf_prog_test_run(): '%s'", STRERR(errno));
	EXPECT_EQ(self->retval, variant->expected_retval)
	TH_LOG("expected: %d, actual: %d\n", variant->expected_retval,
	       self->retval);
}

TEST_HARNESS_MAIN
